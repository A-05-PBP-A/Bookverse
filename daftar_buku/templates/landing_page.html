{% extends 'base.html' %}
{% load static %}

{% block content%}
<body>
    <div style="padding: 40px;">
        <div class="container mt-4">
            <div class="form-group">
              <input type="text" class="form-control" id="searchKeyword" placeholder="Enter keyword">
            </div>
            <div class="form-group">
              <select class="form-control" id="filterType">
                <option value="title">Title</option>
                <option value="author">Author</option>
                <option value="publication_year">Publication Year</option>
                <option value="publisher">Publisher</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="callFiltered()">Filter</button>
        </div>

        <br>
        <h1 style="padding-left: 20px;">Discover Books</h1>
        <br>

        <div class = "container">
            <div class="row" id="books_display"></div>
        </div>

    </div>

    <script>
        async function getProducts() {
            return fetch("{% url 'daftar_buku:get_books_json' %}").then((res) => res.json())
        }

        async function refreshProducts(func) {
            document.getElementById("books_display").innerHTML = ""
            const products = await func()
            let htmlString = ``
            products.forEach((item) => {
                htmlString += `
                    <div class="col-md-3">
                        <a href="/book/${item.pk}/" style="text-decoration: none; color: inherit;">
                        <div class="card" style="width: 15rem; height: 32rem; margin: 20px">
                            <img src="${item.fields.image_url_l}" class="card-img-top" alt="book image" style="height:20rem">
                            <div class="card-body" style="overflow: hidden;">
                                <h5 class="card-title" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">${item.fields.title}</h5>
                                <h6 class="card-subtitle mb-2 text-body-secondary">${item.fields.author}</h6>
                                <p class="card-text">${item.fields.publication_year}</p>
                                <p class="card-text">${item.fields.publisher}</p>
                            </div>
                        </div>
                        </a>
                    </div>` 
                })
                
                document.getElementById("books_display").innerHTML = htmlString
        }
        refreshProducts(getProducts)

        async function filterBooks() {
            const keyword = document.getElementById("searchKeyword").value;
            const filterType = document.getElementById("filterType").value;
    
            return fetch("{% url 'daftar_buku:filter_books' %}?keyword=" + keyword + "&filter_type=" + filterType).then((res) => res.json());
        }

        async function callFiltered() {
            refreshProducts(filterBooks);
        }
        
    </script>
</body>
{% endblock content %}